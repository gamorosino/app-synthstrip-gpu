#!/bin/bash
#PBS -l nodes=1:ppn=1,vmem=8g,walltime=2:00:00
#PBS -N app-synthstrip
#PBS -V


#set -e

t1=$(jq -r .t1 config.json)
t2=$(jq -r .t2 config.json)
no_csf=$( jq -r .no_csf config.json )
use_gpu=$( jq -r .use_gpu config.json )

# Custom singularity runner
singularity_run() {
    nvflag=${2}
    if [ "${nvflag}" -eq 1 ]; then
        nvcmd=" --nv "
    else
       nvcmd="" 
    fi
    singularity exec -e ${nvcmd} docker://"$1" "${@:3}"
}

if [ "${t1}" != "null" ]; then
    input=$t1
    outputdir=t1_brain
    output=t1.nii.gz
elif [ "${t2}" != "null" ]; then

    input=$t2
    outputdir=t2_brain
    output=t2.nii.gz   
else
    
    echo "Datatype not supported" >&2
    exit -1
fi

mkdir ${outputdir}
mkdir mask

no_csf_opt=''
nvflag=0
[ "${no_csf}"  == "true" ] && { no_csf_opt=" --no-csf "; }

if [ "${use_gpu}" == "true" ]; then

    docker="freesurfer/synthstrip:1.7-gpu "
    nvflag=1
else
    docker=freesurfer/synthstrip:1.7
    nvflag=0
fi

singularity_run ${docker} ${nvflag} mri_synthstrip  -i ${input} -o ./${outputdir}/${output} -m ./mask/mask.nii.gz ${no_csf_opt}

